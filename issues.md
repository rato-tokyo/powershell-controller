# 現状の課題と改善方針

## 優先度の高い課題

1. **テスト網羅性の向上**
   - 課題: テストケースのカバレッジを向上させる必要がある
   - 改善方針: 境界値テストやエラーケーステストを追加する

2. **ドキュメント整備**
   - 課題: 使用方法や内部設計に関するドキュメントが不足している
   - 改善方針: READMEの拡充とAPIドキュメントの整備

3. **MDCルールとコードベースの整合性**
   - 課題: MDCに記載されているルールと実際のコードベースに不整合がある
   - 改善方針: 以下の不整合を解消する
     - `green.mdc`で指定されている`result`型を使用したエラー処理が一部のコードで実装されていない
     - テスト構造が`python_test.mdc`で指定された構造と完全に一致していない

4. **PowerShellコマンド実行の互換性問題**
   - 課題: PowerShell環境でのパス処理やコマンド構文に関する互換性問題が存在する
   - 改善方針: 以下の問題に対処する
     - 長いパス名や複雑なパス名を含むコマンドでのバッファオーバーフロー
     - Unix/Linux系コマンド構文とPowerShellコマンドレットの構文の違いによるエラー
     - 複数ファイルの一括処理をクロスプラットフォームで動作させるためのスクリプト改善

5. **型チェッカーのエラー解消**
   - 課題: mypyによる型チェックで多くのエラーが検出されている
   - 改善方針: 以下の問題を修正する
     - クラス構造の変更に伴うインターフェース不整合（特にPowerShellControllerSettings）
     - 変数の再定義エラー（same name used for multiple variables）
     - 戻り値の型エラー（Returning Any from function declared to return specific type）
     - 到達不能コード（Statement is unreachable）
     - 抽象クラスの実装漏れ（abstract attributes not implemented）

6. **PowerShell PSReadLineモジュールのバグ対応**
   - 課題: コマンド実行時にPSReadLineモジュールのバグによりArgumentOutOfRangeExceptionが発生する
   - 改善方針: 以下の対策を実施する
     - 長いコマンドを複数の短いコマンドに分割して実行する
     - コマンド実行前にバッファサイズを確認・調整する処理を追加
     - PSReadLineモジュールのバージョン互換性を確認し、安定バージョンを使用するよう推奨する
     - コマンド実行時の代替手段（スクリプトファイル経由での実行など）を提供する

7. **ツール制限の文書化と回避策の提供**
   - 課題: 開発に使用されるツールの制限が文書化されておらず、回避策が共有されていない
   - 改善方針: 以下の対策を実施する
     - ツールの制限に関するMDCファイル（tool_constraints.mdc）を作成・維持する
     - 制限を発見した場合の報告フローを確立する
     - 既知の制限に対する回避策を具体的なコード例とともに提供する
     - 新しいツールや機能を導入する際に既知の制限をテストする仕組みを整備する

8. **一時ファイル管理の方針整備**
   - 課題: テストや検証で作成した一時ファイルが削除されずに残っている
   - 改善方針: 以下の対策を実施する
     - 一時ファイル管理に関するルールを適切なMDCに記載する
     - テスト・検証完了後の自動クリーンアップ手順を確立する
     - 一時ファイルの命名規則と保持期間のポリシーを定める
     - 使用目的に応じた一時ファイルの管理方法を整理する

9. **MDC構造の最適化と記載場所選定ガイドラインの作成**
   - 課題: MDCファイル間の責任分担が曖昧で、新規情報の追加時に適切な記載場所を選定しづらい
   - 改善方針: 以下の対策を実施する
     - MDCファイル間の明確な責任分担を定義する
     - 情報の種類・目的に応じた適切な記載場所を決定するためのフローチャートを作成する
     - MDC構造の全体像を視覚化したドキュメントを整備する
     - 新しい課題やルールを追加する際の標準的な手順を確立する

10. **MDCの意味の統一**
    - 課題: MDCの意味が「Model-Driven Coding」と「Markdown Cursor」で混在していた
    - 改善方針: 以下の対策を実施する
      - 全てのMDCファイルで「Markdown Cursor」に統一する
      - 主要なMDCファイルに「MDCについて」セクションを追加して明確に説明する
      - READMEにもMDCの意味を正確に記載する
      - 今後の新規MDCファイル作成時のテンプレートにMDC説明を含める

## ユーザー対応の課題

## 環境依存の問題

1. **PowerShell 7のPSReadLineモジュールバグ**
   - 問題: Windows環境でのコマンド実行時にPSReadLineモジュールでArgumentOutOfRangeExceptionが発生
   - 発生環境: Windows 10.0.26100, PowerShell 7.5.1, PSReadLine 2.3.6
   - エラーメッセージ: `System.ArgumentOutOfRangeException: The value must be greater than or equal to zero and less than the console's buffer size in that dimension.`
   - 推定原因: コンソールのバッファサイズを超える操作やバッファ位置の計算ミスがPSReadLineモジュールで発生
   - 解決策:
     - 長いコマンドを分割して実行する
     - スクリプトファイルを使用してコマンドを実行する
     - PSReadLineモジュールの更新またはダウングレードを検討する
     - コマンド実行用のラッパー関数を作成し、エラーハンドリングを追加する

2. **run_terminal_cmdツールの制限**
   - 問題: コマンド引数に改行文字を含めることができない
   - 発生環境: すべての環境（ツール自体の制限）
   - エラーメッセージ: `Tool call arguments for run_terminal_cmd were invalid: Argument command must not contain newline characters.`
   - 推定原因: ツールの設計上の制限
   - 解決策:
     - ヒアドキュメント（`@'...'@`）を使用する代わりに、`edit_file`ツールでスクリプトを作成してから実行する
     - 複数行のコマンドを一行に結合して実行する
     - 複雑なコマンドはスクリプトファイルに分離する習慣をつける

## 補足事項

- PowerShell 7の環境依存性への対応
- パフォーマンス最適化（大量のコマンド実行時）
- セキュリティ強化（入力検証の徹底） 