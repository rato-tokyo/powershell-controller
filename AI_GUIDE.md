# PowerShell Controller 開発ガイド

## プロジェクト概要
このプロジェクトは、Pythonから簡単にPowerShellを操作するためのライブラリ「py-pshell」を開発しています。同期・非同期APIを提供し、Windows/Linux/macOSで動作する、クロスプラットフォームなPowerShellコントローラーです。

## 現状の課題と改善案（優先度順）

### 高優先度
1. **インターフェース設計の改善**
   - 現状：
     - 非同期処理と同期的な処理が混在
     - インターフェースの一貫性が欠如
     - 実装の複雑性が増加
   - 改善案：
     - 非同期処理に特化したインターフェースを設計
     - 同期的な処理は非同期処理のラッパーとして実装
     - インターフェースの一貫性を確保
   - 期待効果：
     - 実装の簡素化
     - テストの信頼性向上
     - メンテナンス性の向上

2. **テスト設計の標準化**
   - 現状：
     - 非同期処理のテストパターンが未標準化
     - 実装の詳細に依存したテスト
     - エッジケースのテストが不十分
   - 改善案：
     - 非同期処理のテストパターンを標準化
     - インターフェースベースのテスト設計
     - エッジケースの網羅的なテスト
   - 期待効果：
     - テストの保守性向上
     - バグの早期発見
     - 開発効率の向上

3. **実装の簡素化**
   - 現状：
     - 複数の非同期処理パターンが混在
     - エラーハンドリングが分散
     - 実装の複雑性が高い
   - 改善案：
     - 非同期処理のパターンを統一
     - エラーハンドリングの集約
     - 実装の複雑性を最小限に抑制
   - 期待効果：
     - コードの可読性向上
     - バグの発生リスク低減
     - メンテナンス性の向上

4. **非同期処理の安定性向上**
   - 現状：長時間実行時のメモリリークの可能性があり、非同期処理の警告が発生
   - 改善案：メモリ使用量の監視と自動クリーンアップ機能の実装、非同期処理の完全な制御
   - 期待効果：長時間運用時の安定性向上と警告の完全な解消

5. **エラー検出の自動化**
   - 現状：エラー発生時に手動でログを確認する必要がある
   - 改善案：エラーパターンを定義し、自動検出と通知機能を実装
   - 期待効果：エラー早期発見と迅速な対応が可能に

6. **テストカバレッジの向上**
   - 現状：エッジケースのテストが不足、非同期テストの改善が必要
   - 改善案：pytest-covを導入し、カバレッジレポートを自動生成、非同期テストの強化
   - 期待効果：テスト品質の可視化と改善点の特定が容易に

### 中優先度
7. **パフォーマンス最適化**
   - 現状：大量のコマンド実行時にパフォーマンスが低下
   - 改善案：コマンド実行のバッチ処理機能の実装、非同期処理の最適化
   - 期待効果：大量コマンド実行時の処理速度向上

8. **ドキュメント整備**
   - 現状：APIドキュメントが不足
   - 改善案：Sphinxを使用した自動ドキュメント生成の導入
   - 期待効果：開発者向けドキュメントの充実

### 完了した改善
1. **テストケースの改善**
   - 非同期テストケースの警告を解消
   - テストフィクスチャの改善
   - エラーハンドリングの強化
   - モック処理の信頼性向上

2. **PowerShellControllerの実装改善**
   - `stop()`メソッドを`close()`にリネーム
   - 非同期コンテキストマネージャーの実装を改善
   - `run_command()`と`run_script()`の戻り値型を`CommandResultProtocol`に変更
   - `CommandResult`クラスを`CommandResultProtocol`に準拠

3. **テスト環境の整備**
   - pytest設定の最適化
   - 警告の適切な抑制
   - 非同期テストの実行環境改善

### 次のステップ
1. インターフェースの改善実装
2. メモリ使用量の監視機能実装
3. エラー検出の自動化
4. テストカバレッジの向上
5. パフォーマンス最適化

## テスト構造
- tests/unit: 単体テスト
  - コントローラーのテスト
  - セッション管理のテスト
  - エラーハンドリングのテスト
- tests/integration: 統合テスト
  - 実際のPowerShell操作のテスト
  - 長時間実行のテスト
  - エラー回復のテスト

## 実装時の注意点
- コントローラーとセッションは明確に責務を分離する
- 非同期処理は一貫性を持って実装し、すべての非同期コルーチンを適切に処理する
- エラー処理は集約して、使いやすいAPIを提供する
- 設定はpydanticを用いて検証する
- ログはloguruを使用して適切なレベルで出力する
- テストケースは非同期処理を適切に処理し、リソースを確実に解放する
- モックは適切に設定し、非同期処理を正しくシミュレートする
- インターフェースは「契約」として扱い、実装側がインターフェースに合わせる
- インターフェース変更は最後の手段としてのみ検討

## 開発環境
- Python 3.8以上
- PowerShell 7.x
- Windows/Linux/macOS対応
- 必須パッケージ:
  - loguru: ログ管理
  - pydantic: データ検証
  - tenacity: リトライ処理
  - pytest関連: テストフレームワーク
  - result: エラー処理

## 現状の課題と改善案

### 1. 非同期処理の実装
現状：
- 非同期処理の実行方法が複雑で、イベントループの状態管理が困難
- テストでの非同期処理のモック化が不完全
- エラーハンドリングが不十分

改善案：
- 非同期処理の実行方法を明確に定義し、イベントループの状態に応じた適切な処理方法を選択
- すべての非同期メソッドを適切にモック化し、テストの信頼性を向上
- エラーの種類に応じた適切な処理と、クリーンアップ処理の確実な実行を実装

期待効果：
- 非同期処理の安定性向上
- テストの信頼性向上
- エラーハンドリングの改善

### 2. テスト設計の改善
現状：
- 非同期処理のテストが複雑で、モックの設定が不完全
- テストケース間の依存関係が存在

改善案：
- 非同期処理のテストパターンを標準化
- テストフィクスチャの改善と再利用性の向上
- テストケースの独立性を確保

期待効果：
- テストの保守性向上
- テストの信頼性向上
- 開発効率の向上

### 3. エラーハンドリングの強化
現状：
- エラーの種類に応じた適切な処理が不十分
- クリーンアップ処理の確実な実行が保証されていない

改善案：
- エラーの種類に応じた適切な処理を実装
- クリーンアップ処理の確実な実行を保証
- エラーログの改善

期待効果：
- エラーハンドリングの信頼性向上
- デバッグの効率化
- システムの安定性向上

## プロンプトルール遵守のためのチェックポイント

### 実装前チェックリスト
- [ ] インターフェースは「契約」として不変か
- [ ] 実装は最も単純な方法か
- [ ] テストはインターフェースベースか
- [ ] 非同期処理は一貫性があるか
- [ ] エラーハンドリングは集約されているか
- [ ] テストケースは単一の機能を検証しているか

### 実装承認プロセス
1. インターフェース設計の承認
   - インターフェースの一貫性
   - 非同期処理の設計
   - エラー型の定義

2. テスト設計の承認
   - インターフェースベースのテスト
   - エッジケースの網羅
   - 非同期処理のテストパターン

3. 実装方針の承認
   - 実装の簡素性
   - エラーハンドリングの集約
   - 非同期処理の一貫性

4. コードレビュー
   - プロンプトルールの遵守
   - テストの信頼性
   - 実装の保守性

### フィードバックループ
1. 実装提案時の確認
   - プロンプトルールの原則遵守
   - チェックリストの確認
   - 承認プロセスの遵守

2. 違反検出時の対応
   - 即座の指摘
   - 改善案の提示
   - 再設計の検討

3. 改善後の確認
   - 原則遵守の確認
   - テストの信頼性確認
   - 実装の簡素性確認

4. 継続的な改善
   - 課題の記録
   - 改善案の検討
   - プロセスの最適化

## コンテキスト管理戦略

### プロンプトルールの分割
1. 基本原則（常時参照）
   - インターフェース不変の原則
   - 実装の簡素性
   - テストの信頼性

2. 実装ガイドライン（必要時参照）
   - 非同期処理の設計
   - エラーハンドリング
   - テスト設計

3. チェックリスト（各ステップで参照）
   - 実装前チェックリスト
   - テスト設計チェックリスト
   - レビューチェックリスト

### コンテキスト更新のタイミング
1. 新規開発時
   - 機能設計開始時
   - インターフェース設計時
   - 実装開始時

2. エラー解決時
   - エラー発生時
   - 解決策検討時
   - 実装修正時

3. レビュー時
   - コードレビュー時
   - テストレビュー時
   - 設計レビュー時

### コンテキストの優先順位
1. エラー解決時
   - 関連する原則の優先表示
   - エラー解決の即時性
   - 原則遵守の確認

2. 実装時
   - 設計原則の優先表示
   - 実装の簡素性
   - テストの信頼性

3. テスト時
   - テスト設計原則の優先表示
   - エッジケースの網羅
   - 非同期処理のテスト

### コンテキスト管理のベストプラクティス
1. 定期的な更新
   - 開発セッション開始時
   - 実装フェーズ変更時
   - レビューポイント時

2. 関連性の維持
   - 現在の作業に関連する原則の強調
   - 不要なコンテキストの削除
   - コンテキストの鮮度維持

3. フィードバックの活用
   - コンテキストの有効性評価
   - 改善点の記録
   - プロセスの最適化 