# MDC構造の最適化と記載場所選定ガイドライン

## 概要
このガイドラインは、MDC（Markdown Cursor）ファイル間の責任分担を明確化し、新しい情報を追加する際に適切な記載場所を選定するための基準を提供します。MDC構造の一貫性を維持し、情報の検索性と更新容易性を向上させることを目的としています。

## MDCファイル階層構造

```
.cursor/rules/
├── README.md                 # MDC概要説明
├── environment.mdc           # 開発環境の設定と一時ファイル管理
├── flow_overview.mdc         # フロー全体の説明
├── python_test.mdc           # Pythonテスト規約
├── tool_settings.mdc         # ツール設定一元管理
├── docs/                     # 基本ドキュメント
│   ├── flow_execution.mdc    # フロー実行方法
│   ├── flow_phase.mdc        # 旧方針（参考用）
│   ├── init.mdc              # 初期セットアップ
│   ├── main.mdc              # 基本ルール
│   ├── manual_reference.mdc  # 現行方針
│   ├── mdc_metamodel.mdc     # MDC構造定義
│   ├── rail.mdc              # 旧方針（参考用）
│   └── tool_constraints.mdc  # ツール制限と対策
└── flows/                    # フロー定義
    ├── main.mdc              # フロー基本ルール
    ├── main/                 # メインフロー
    │   ├── code_quality.mdc  # コード品質向上フロー
    │   ├── issue_improvement.mdc # 課題改善フロー
    │   ├── mdc_check.mdc     # MDC整合性確認フロー
    │   └── requirements_change.mdc # 仕様変更フロー
    └── phases/               # フェーズ固有フロー
        ├── contract.mdc      # 契約フェーズ
        ├── document.mdc      # ドキュメントフェーズ
        ├── green.mdc         # 実装フェーズ
        ├── red.mdc           # テスト作成フェーズ
        └── refactor.mdc      # リファクタリングフェーズ
```

## MDCファイルの責任分担

### コアMDC（基本構造・方針）
| ファイル | 責任範囲 | 記載内容の例 |
|---------|---------|-------------|
| `docs/main.mdc` | 基本ルールと参照ガイド | プロジェクト概要、MDC参照方法 |
| `docs/init.mdc` | 初期セットアップ手順 | 新規セッション開始時の確認事項 |
| `flow_overview.mdc` | フロー全体像 | フロー間の関係、フェーズ移行条件 |

### 環境・ツール関連MDC
| ファイル | 責任範囲 | 記載内容の例 |
|---------|---------|-------------|
| `environment.mdc` | 開発環境設定と一時ファイル管理 | 環境構築手順、一時ファイル管理ルール |
| `tool_settings.mdc` | ツール設定の一元管理 | ツールの設定値、推奨設定 |
| `docs/tool_constraints.mdc` | ツール制限と対策 | 既知の制限、回避策、代替手段 |

### フロー関連MDC
| ファイル | 責任範囲 | 記載内容の例 |
|---------|---------|-------------|
| `flows/main/*.mdc` | 各メインフローの定義 | フロー全体の手順と目的 |
| `flows/phases/*.mdc` | フェーズ固有フロー | 特定フェーズ特化のフロー |
| `docs/flow_execution.mdc` | フロー実行方法 | MDC添付方法、実行手順 |

## 情報タイプ別の記載場所選定フローチャート

新しい情報を追加する際は、以下のフローチャートに従って記載場所を選定してください。

1. **情報の種類を特定する**
   - プロジェクト全体の基本ルール → `docs/main.mdc`
   - 環境設定関連情報 → `environment.mdc`
   - ツール設定値 → `tool_settings.mdc`
   - ツールの制限と対策 → `docs/tool_constraints.mdc`
   - 一時ファイル管理ルール → `environment.mdc`
   - フロー全体の説明 → `flow_overview.mdc`
   - 特定のメインフロー → `flows/main/*.mdc`
   - フェーズ定義 → `flows/phases/*.mdc`
   - テスト規約 → `python_test.mdc`
   - フロー実行方法 → `docs/flow_execution.mdc`
   - 開発方針 → `docs/manual_reference.mdc`（現行）または新規作成

2. **既存のMDCに適合するか確認する**
   - 適合する → そのMDCに追加
   - 部分的に適合する → 最も近いMDCに追加し、必要に応じて構造を調整
   - 適合しない → 新しいMDCの作成を検討

3. **新しいMDCを作成する場合**
   - 情報の性質に基づいて適切なディレクトリを選択
   - 命名規則：`[カテゴリ]_[サブカテゴリ]_[詳細].mdc`
   - 基本構造：タイトル、概要、責任範囲、詳細内容、関連MDC参照
   - `docs/main.mdc`に新しいMDCの参照を追加

## MDC情報更新ガイドライン

### 記載場所の選定基準
1. **単一責任の原則**: 各MDCファイルは明確に定義された一つの責任範囲を持つ
2. **凝集性**: 関連する情報は同じMDCファイルまたは同じディレクトリ内に配置
3. **安定性**: 頻繁に変更される情報と安定した情報を分離
4. **検索性**: 情報が論理的に探しやすい場所に配置

### 情報追加手順
1. 追加する情報の種類を特定
2. 上記のフローチャートを使用して適切な記載場所を選定
3. 既存の構造とフォーマットに合わせて情報を追加
4. 関連MDCからの参照リンクを必要に応じて追加
5. `issues.md`の関連課題を更新

### 情報更新手順
1. 更新が必要なMDCファイルを特定
2. 更新内容が他のMDCファイルに影響するか確認
3. 影響範囲に基づいて関連MDCも更新
4. `issues.md`の関連課題を更新

## 空フォルダ管理ガイドライン

### 空フォルダの取り扱い原則
1. **不要な空フォルダは削除する**: MDC構造をクリーンに保つため、不要な空フォルダは直ちに削除する
2. **空フォルダの防止**: 新しいMDCファイル作成時は、適切なディレクトリ構造を事前に確認する
3. **一時的に必要な空フォルダ**: 将来使用する予定がある空フォルダには `.keep` ファイルを配置する

### 空フォルダチェック手順
1. MDC更新作業完了時に、以下の手順で空フォルダをチェックする：
   ```powershell
   Get-ChildItem -Path ".cursor/rules" -Recurse -Directory | 
   Where-Object { (Get-ChildItem -Path $_.FullName -File -Recurse).Count -eq 0 } | 
   ForEach-Object { Write-Output "空フォルダ: $($_.FullName)" }
   ```
2. 確認された空フォルダが不要な場合は、以下のコマンドで削除する：
   ```powershell
   Remove-Item -Path "空フォルダパス" -Force -Recurse
   ```

### 空フォルダ発生の主な原因と対策
1. **リファクタリング時**: MDC構造の変更時に元のファイルを移動したが、フォルダは削除しなかった
   - 対策: リファクタリング手順に「不要フォルダの削除」ステップを追加する
2. **一時的な作業フォルダ**: 検証用などの一時的なフォルダが削除されていない
   - 対策: 一時フォルダの命名規則を定め（例: `temp_*`）、定期的に削除する
3. **計画変更**: 当初予定されていたMDCが不要になったが、フォルダ構造だけが残った
   - 対策: MDC計画変更時に影響範囲分析に「不要になるディレクトリ」の確認を含める

### 空フォルダ管理の自動化
MDC整合性確認フロー（`flows/main/mdc_check.mdc`）に以下の空フォルダチェック機能を追加することを推奨します：
1. 空フォルダの自動検出
2. 継続的に空のままのフォルダのレポート
3. 不要と判断された空フォルダの自動削除オプション

## 課題一覧（issues.md）の構造最適化

issues.mdは以下の構造に最適化することを推奨します：

```
# 現状の課題と改善方針

## 優先度の高い課題
1. **[カテゴリ] 課題タイトル**
   - 課題: 具体的な問題の説明
   - 改善方針: 対応策の概要
   - 関連MDC: 対応するMDCファイルへの参照
   - ステータス: [未着手/進行中/解決済み]
   - 更新日: YYYY-MM-DD

## ユーザー対応の課題
（同様の構造）

## 環境依存の問題
（同様の構造）

## 補足事項
（一般的な補足情報）
```

### issues.mdへの新規課題追加ガイドライン
1. 適切なセクションを選択（優先度の高い課題/ユーザー対応の課題/環境依存の問題）
2. 標準フォーマットに従って課題を記述
3. 関連するMDCファイルがある場合は参照を追加
4. 優先度を適切に評価して配置

## MDC更新検証チェックリスト

MDCを更新した後は、以下のチェックリストを使用して整合性を確認してください：

1. [ ] 更新内容は適切なMDCファイルに記載されているか
2. [ ] 関連するMDCファイルへの参照リンクは正確か
3. [ ] 更新内容は既存の構造とフォーマットに準拠しているか
4. [ ] 更新がissues.mdの対応する課題に反映されているか
5. [ ] 必要に応じて他のMDCファイルも更新されているか
6. [ ] 不要な空フォルダが残っていないか確認したか

## MDC即時ドキュメント化プロセス

### エラー・問題発生時の即時ドキュメント化ルール

MDCルール遵守の重要性を再確認し、特に問題やエラーが発生した場合の即時ドキュメント化を徹底するための手順です。
**問題発生時は、最初に[MDC参照インデックス](mdc_reference_index.mdc)を参照し、適切なMDCを特定してください。**

#### 即時ドキュメント化の基本原則
1. **先にドキュメント、後に解決**: 問題が発生したら、まず`issues.md`に記録してから解決に取り組む
2. **ドキュメント化の時間枠**: 問題発見から24時間以内に必ずドキュメント化する
3. **最小限の記録でも可**: 緊急時は簡潔な記録でも良いので、まず記録することを優先する

#### 問題発生時のドキュメント化手順
1. **問題の初期記録**（発生時点で即時実施）
   ```markdown
   **[カテゴリ] 問題の簡潔な説明**
   - 問題: 現象の概要
   - 発生環境: OS、バージョン情報
   - エラーメッセージ: `実際のエラーメッセージ`
   - 関連MDC: 関連するMDCファイル
   - ステータス: 未解決
   - 更新日: YYYY-MM-DD
   ```

2. **詳細情報の追記**（時間的余裕があるとき）
   - 推定原因の分析
   - 一時的な回避策または解決策
   - 発生条件や再現手順

3. **解決後の更新**
   - 恒久的な解決策の追記
   - ステータスの更新（「解決済み」または「回避策あり」）
   - 今後の対策や提案

### コマンド実行エラー記録のためのショートカットプロセス

特にPowerShellコマンド実行時のエラーについては、以下のショートカットプロセスを使用してすぐに記録してください：

1. エラーが発生したら、以下のコマンドを実行して`issues.md`に直接追記：
   ```powershell
   $errorInfo = @"
   **[PowerShell] $(Get-Date -Format "yyyy-MM-dd HH:mm") - エラー概要**
   - 問題: <エラーの簡潔な説明>
   - 発生環境: Windows $(([System.Environment]::OSVersion.Version).ToString()), PowerShell $($PSVersionTable.PSVersion)
   - エラーメッセージ: `$($Error[0].Exception.Message)`
   - 実行コマンド: `<実行したコマンド>`
   - ステータス: 未解決
   - 更新日: $(Get-Date -Format "yyyy-MM-dd")
   "@
   
   Add-Content -Path "issues.md" -Value $errorInfo
   ```

2. 24時間以内に必ず詳細情報を追記し、適切なセクションに移動させる

### MDC不履行の防止策

MDCルールが遵守されない主な原因と対策：

1. **即時性優先による記録後回し**
   - 対策: 「記録→解決」の順序を徹底する
   - 具体策: 問題解決スクリプト実行前に必ず最小限の記録を残す習慣づけ
   - **ツール**: [MDC参照インデックス](mdc_reference_index.mdc)の緊急時テンプレートを使用

2. **エラー記録の重要性認識不足**
   - 対策: MDC更新の重要性を再確認する機会を設ける
   - 具体策: 作業開始時と終了時にMDC確認チェックポイントを設ける

3. **慣れによる手順スキップ**
   - 対策: MDC更新をスキップできない仕組みを導入
   - 具体策: 作業完了報告時に「MDC更新の有無」を明示的に報告する項目を追加

4. **緊急時の処理優先傾向**
   - 対策: 緊急時にも使えるショートカットプロセスを用意
   - 具体策: 最小限の情報だけでも記録できるテンプレートと簡易手順の提供

## MDC構造の視覚化

MDCファイル間の関係を以下の図で視覚化します：

```
docs/main.mdc ─┬─→ flow_overview.mdc ──┬─→ flows/main/*.mdc
               │                        └─→ flows/phases/*.mdc
               ├─→ environment.mdc ─────┬─→ tool_settings.mdc
               │                        └─→ docs/tool_constraints.mdc
               ├─→ docs/flow_execution.mdc
               └─→ docs/manual_reference.mdc
```

## MDC構造改善の定期レビュー

MDC構造の改善は以下のタイミングで実施します：

1. 新しい開発フローやツールを導入する際
2. 既存のMDCが肥大化した場合
3. MDC整合性確認フロー実行時（定期的に実施）
4. プロジェクト方針の大きな変更があった場合

## 今後の展望

1. MDC選択ガイドの対話型ツール開発
2. MDC構造の自動検証スクリプト
3. MDC更新履歴の自動記録メカニズム
4. MDCリンクチェッカーの導入
5. 不要フォルダの自動検出と削除ツールの開発 